trigger:
  branches:
    include:
      - main

variables:
  IMAGE_NAME: 'serviceexample'
  TAG: '$(Build.BuildId)'

stages:
  - stage: BuildAndPush
    displayName: "Build and Push Docker Image"
    jobs:
      - job: Build
        pool:
          name: SelfHostedPool
        timeoutInMinutes: 10
        steps:
          - checkout: self
            displayName: 'Checkout source code'

          - script: dotnet restore
            displayName: 'Restore .NET Dependencies'

          - script: dotnet build --configuration Release --no-restore
            displayName: 'Build Project'

          - script: dotnet test --configuration Release --verbosity minimal
            displayName: 'Run Unit Tests'

          # ðŸ”¥ MANUAL DOCKER BUILD WITH VERBOSE LOGGING
          - task: Bash@3
            displayName: 'Debug Docker Build'
            inputs:
              targetType: 'inline'
              script: |
                echo "=== Starting Docker Build at: $(date) ==="
                echo "Current directory: $(pwd)"
                echo "Files in directory:"
                ls -la
                
                echo "=== Docker Build Started ==="
                time docker build -t serviceexampleacr.azurecr.io/$(IMAGE_NAME):$(TAG) . \
                  --progress=plain \
                  --no-cache \
                  --pull
                
                echo "=== Docker Build Completed at: $(date) ==="
                echo "Build time statistics above"
