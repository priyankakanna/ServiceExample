# azure-pipeline-simple.yml
trigger:
  branches:
    include:
      - main

variables:
  IMAGE_NAME: 'serviceexample'
  TAG: '$(Build.BuildId)'
  # Use a fixed ACR name that you create manually once
  ACR_NAME: 'serviceexampledemo' 

stages:
  - stage: BuildAndPush
    displayName: "Build and Push to ACR"
    jobs:
      - job: Build
        pool:
          name: SelfHostedPool
        steps:
          - checkout: self
            displayName: 'Checkout source code'

          - script: dotnet restore
            displayName: 'Restore .NET Dependencies'

          - script: dotnet build --configuration Release --no-restore
            displayName: 'Build Project'

          - script: dotnet test --configuration Release --verbosity minimal
            displayName: 'Run Unit Tests'

          # BUILD and PUSH in one task
          - task: Docker@2
            displayName: 'Build and Push to ACR'
            inputs:
              command: buildAndPush
              repository: $(IMAGE_NAME)
              dockerfile: '**/Dockerfile'
              containerRegistry: 'serviceexampleacr'  # Your existing connection
              tags: |
                $(TAG)
                latest

          # VERIFICATION
          - task: Bash@3
            displayName: 'Verify Push'
            inputs:
              targetType: 'inline'
              script: |
                echo "ðŸŽ‰ === DEMO READY === ðŸŽ‰"
                echo "Image pushed successfully to ACR"
                echo "Use your existing ACR for demo"
