trigger:
  branches:
    include:
      - main

variables:
  IMAGE_NAME: 'serviceexample'
  TAG: '$(Build.BuildId)'

stages:
  - stage: BuildAndPush
    displayName: "Build and Push Docker Image"
    jobs:
      - job: Build
        pool:
          name: SelfHostedPool
        timeoutInMinutes: 8
        steps:
          - checkout: self
            displayName: 'Checkout source code'

          - script: dotnet restore
            displayName: 'Restore .NET Dependencies'

          - script: dotnet build --configuration Release --no-restore
            displayName: 'Build Project'

          - script: dotnet test --configuration Release --verbosity minimal
            displayName: 'Run Unit Tests'

          # ðŸ”¥ SEPARATE BUILD STEP
          - task: Docker@2
            displayName: 'Build Docker Image'
            inputs:
              containerRegistry: 'serviceexampleacr'
              repository: '$(IMAGE_NAME)'
              command: 'build'
              dockerfile: 'Dockerfile'
              tags: $(TAG)
              arguments: '--progress=plain'

          # ðŸ”¥ SEPARATE PUSH STEP  
          - task: Docker@2
            displayName: 'Push Docker Image'
            inputs:
              containerRegistry: 'serviceexampleacr'
              repository: '$(IMAGE_NAME)'
              command: 'push'
              tags: $(TAG)
