# azure-pipelines.yml
trigger:
- main

pool: SelfHostedPool

variables:
  IMAGE_NAME: 'serviceexample'
  TAG: '$(Build.BuildId)'

steps:
- checkout: self
  displayName: 'Checkout code'

- script: |
    echo "=== BUILDING .NET APPLICATION ==="
    dotnet restore
    dotnet build --configuration Release --no-restore
    dotnet test --configuration Release --verbosity minimal
    echo "‚úÖ .NET app built and tested"
  displayName: 'Build and Test .NET App'

- script: |
    echo "=== AUTHENTICATING WITH ACR ==="
    podman login serviceexampleacr.azurecr.io --username "$(acrUsername)" --password "$(acrPassword)"
    echo "‚úÖ Logged into ACR successfully"
  displayName: 'Login to ACR'
  env:
    acrUsername: $(acrUsername)
    acrPassword: $(acrPassword)

- script: |
    echo "=== BUILDING CONTAINER IMAGE ==="
    podman build -t serviceexampleacr.azurecr.io/$(IMAGE_NAME):$(TAG) -f Dockerfile .
    echo "‚úÖ Image built successfully"
  displayName: 'Build Container Image'

- script: |
    echo "=== PUSHING TO ACR ==="
    podman push serviceexampleacr.azurecr.io/$(IMAGE_NAME):$(TAG)
    echo "‚úÖ Image pushed: serviceexampleacr.azurecr.io/$(IMAGE_NAME):$(TAG)"
  displayName: 'Push Image with Build ID'

- script: |
    echo "=== TAGGING AS LATEST ==="
    podman tag serviceexampleacr.azurecr.io/$(IMAGE_NAME):$(TAG) serviceexampleacr.azurecr.io/$(IMAGE_NAME):latest
    podman push serviceexampleacr.azurecr.io/$(IMAGE_NAME):latest
    echo "‚úÖ Latest tag pushed: serviceexampleacr.azurecr.io/$(IMAGE_NAME):latest"
  displayName: 'Push Latest Tag'

- script: |
    echo "üéâ === DEVOPS DEMO COMPLETE === üéâ"
    echo "‚úÖ Self-hosted Kubernetes cluster"
    echo "‚úÖ Self-hosted Azure DevOps agent"
    echo "‚úÖ Helm chart published to ArtifactHub"
    echo "‚úÖ GitOps with ArgoCD"
    echo "‚úÖ Full CI/CD pipeline with ACR integration"
    echo "üì¶ Image: serviceexampleacr.azurecr.io/$(IMAGE_NAME):$(TAG)"
    echo "üè† Running on: $(Agent.MachineName)"
    echo "üîó ACR: serviceexampleacr.azurecr.io"
  displayName: 'Demo Complete'
